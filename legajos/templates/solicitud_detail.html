<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Detalle Solicitud</title>
</head>
<body>
<h1>Solicitud #{{ solicitud.id }} - {{ solicitud.get_estado_display }}</h1>
<p><a href="{% url 'solicitud_list' %}">Volver a solicitudes</a> | <a href="{% url 'dashboard' %}">Dashboard</a> | <a href="{% url 'logout' %}">Cerrar sesión</a></p>
<p>Creada: {{ solicitud.creado_en }} | Actualizada: {{ solicitud.actualizado_en }}</p>
<h2>Items</h2>
<ul>
{% for item in solicitud.items.all %}
    <li>{{ item.legajo.codigo }} - {{ item.legajo.nombre }} (Disponible al crear: {{ item.disponible_al_crear }})</li>
{% empty %}
    <li>Sin items</li>
{% endfor %}
</ul>
<h2>Préstamos</h2>
{% if puede_preparar %}
<form method="post" action="{% url 'solicitud_preparar' solicitud.pk %}">
    {% csrf_token %}
    <p>Seleccioná los legajos encontrados. Los no seleccionados se marcarán como extraviados.</p>
    <ul style="list-style:none;padding-left:0;">
    {% for prestamo in prestamos_pendientes %}
        <li>
            <label>
                <input type="checkbox" name="prestamos_listos" value="{{ prestamo.pk }}">
                {{ prestamo.legajo.codigo }} - {{ prestamo.legajo.nombre }}
            </label>
        </li>
    {% empty %}
        <li>Sin legajos pendientes por preparar.</li>
    {% endfor %}
    </ul>
    {% if prestamos_pendientes %}
    <button type="submit">Confirmar preparación</button>
    {% endif %}
</form>
{% endif %}
<table border="1" cellpadding="4">
    <thead>
        <tr>
            <th>Legajo</th>
            <th>Estado</th>
            <th>Entregado</th>
            <th>Devuelto</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
    {% for p in solicitud.prestamos.all %}
        <tr>
            <td>{{ p.legajo.codigo }} - {{ p.legajo.nombre }}</td>
            <td>{{ p.get_estado_display }}</td>
            <td>{{ p.entregado_en|default:'-' }}</td>
            <td>{{ p.devuelto_en|default:'-' }}</td>
            <td>
                {% if not es_admin and p.estado == estado_entregado %}
                    <a href="{% url 'prestamo_devolver' p.pk %}">Devolver</a>
                {% endif %}
            </td>
        </tr>
    {% empty %}
        <tr><td colspan="5">Sin prestamos</td></tr>
    {% endfor %}
    </tbody>
</table>
{% if puede_confirmar_entrega %}
<form method="post" action="{% url 'solicitud_confirmar_entrega' solicitud.pk %}" style="margin-top:1rem;">
    {% csrf_token %}
    <p>Confirmá la recepción de los legajos listos para entrega.</p>
    <button type="submit">Confirmar recepción</button>
</form>
{% endif %}
</body>
</html>